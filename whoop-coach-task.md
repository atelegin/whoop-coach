# WHOOP × Telegram Coach — MVP Spec (Full, v2)
**Фокус:** рекомендации тренировок на 3 дня (бег по WHOOP-зонам + YouTube-ролики) с персонализацией по фидбеку, учётом всех активностей WHOOP, режимом “без гири в поездке” и собственной оценкой VO₂max (trend) из данных бега.

---

## 0) Коротко о продукте
Telegram-бот, который:
- шлёт **план на 3 дня** сразу после того, как WHOOP обновил утренний Recovery (время пробуждения у тебя плавающее);
- на **сегодня** даёт **2–3 опции** (бег / барре / силовая / мобилити / ходьба и т.п.) и коротко “почему”;
- рекомендует **YouTube-ролики** из пула каналов + “похожие” и учится по твоим оценкам/отказам;
- учитывает **все** активности из WHOOP (ходьба/плавание/лыжи и т.д.), а **уточняет фидбек только когда это важно**;
- собирает фидбек: **RPE 1–5** после нужных тренировок; утром **soreness 0–3** и **“где болит”** (по ситуации);
- VO₂max (WHOOP-метрика) — **ручной ввод раз в неделю** (бот спрашивает по вторникам);
- строит **собственную оценку VO₂max_est** из бега (скорость + HR + поправка на набор высоты) для недельного тренда;
- поддерживает режим доступности инвентаря: **дом (гиря)** / **поездка (ремни)** / **поездка (ничего)**.

---

## 1) Цели и метрики
### 1.1 North Star (еженедельная)
- **VO2max_manual** — ручной ввод раз в неделю (вторник) из WHOOP (чтобы видеть “официальный” тренд).
- **VO2max_est_submax** — автоматический weekly-trend из беговых тренировок (см. раздел 12).

### 1.2 Ежедневная цель оптимизации
Максимизировать прогресс “беговой аэробной формы” (поддерживать 1–2 пробежки/нед + регулярная силовая/стабилизация) при минимизации:
- ожидаемого ухудшения Recovery/сна завтра,
- ожидаемой soreness,
- риска боли/перегруза (по твоим отметкам “где болит”).

**Зоны берём по WHOOP zones.**  
**Важно:** у тебя “база бега” по умолчанию = **Z3**. Z2 — опционально (можно run-walk), без давления.

---

## 2) Основные определения
### 2.1 Типы активностей
- **Planned**: то, что ты логируешь боту (YouTube-ролик, /run).
- **Unattributed**: всё, что пришло из WHOOP, но ты боту не логировала (walk/swim/ski и т.д.).

### 2.2 Бег (user-specific)
- **Default base run (Z3)**: твой обычный бег в Z3.
  - A: 20–45 минут “как получается” в Z3
  - B: 2×10–15 минут Z3 с 3–5 минут легко/ходьба между
- **High quality run (Z4)**: “качество” — удержание Z4 (дороже по восстановлению).
  - A: 10–25 минут суммарно в Z4
  - B: 2×8–10 минут Z4 с 3–5 минут легко между
- **Easy run (Z2) — optional**: только если достижимо/комфортно; допускается run-walk.

**Лимиты (стартовые):**
- цель: стремиться к 2 пробежкам/нед (дни не фиксируем)
- **Z4 ≤ 2** за последние 7 дней
- **≥48 часов** между любыми Z4
- при риске: `Z4 → Z3 → (опц) Z2 run-walk → low-impact`

### 2.3 Силовые/стабилизация
- **Kettlebell**: гиря **12 кг** и **20 кг** (долгое время)
  - профиль нагрузки = `(video_id, kb_weight_kg)`
- **Bands**: ремни/жгуты (в поездке)
- **Bodyweight**: без инвентаря (в поездке)

### 2.4 Фидбек
- **RPE 1–5** (после нужных тренировок)
- **Soreness 0–3** утром
- **Pain locations**: `нет`, `колено`, `икры`, `бедро`, `поясница`, `плечо` (можно несколько)

---

## 3) Equipment profile (режим инвентаря)
### 3.1 Состояния
`equipment_profile` (сохраняется в профиле пользователя):
- `home_full` — дома: гиря доступна (12/20)
- `travel_bands` — в поездке: гири нет, ремни/жгуты есть
- `travel_none` — в поездке: ни гири, ни ремней (bodyweight)

### 3.2 Влияние на план
- `home_full`: можно предлагать гирю + барре/мобилити
- `travel_bands`: **нельзя** предлагать гирю; вместо неё — bands strength
- `travel_none`: **нельзя** предлагать гирю/ремни; вместо них — bodyweight strength

---

## 4) Интеграции
### 4.1 WHOOP
- OAuth авторизация
- получаем:
  - cycles/day: recovery, sleep, (daily strain при наличии)
  - workouts: start/end, type, strain, avg HR, distance, altitude gain, zone durations (если доступны)
- вебхуки:
  - ключевой триггер: “утренний recovery готов” → отправка плана на 3 дня

### 4.2 Telegram
- бот + inline кнопки
- хранение связки `telegram_user_id ↔ whoop_user`

### 4.3 YouTube
MVP: **пул каналов + похожие**, без глобального поиска по всему YouTube.
- пул стартует с каналов из твоих ссылок
- каждый новый ролик от тебя добавляет его канал в пул
- “похожие” выбираем рядом с понравившимися роликами и в рамках управляемой выдачи
- языки: RU/EN

---

## 5) UX-потоки
### 5.1 Утренний план на 3 дня (авто)
Триггер: WHOOP обновил recovery.

Сообщение:
- Recovery + коротко про сон
- “Инвентарь сегодня: дом / ремни / ничего”
- “Сегодня (выбери 1)” — 2–3 опции
- “Завтра/послезавтра” — черновик с ветвлениями

Кнопки: `Выбираю A` `Выбираю B` (опц `Выбираю C`) + `/plan` + `Почему так?`.

### 5.2 Логирование ролика ПОСЛЕ тренировки (основной протокол)
Ты отправляешь ссылку после тренировки и проверяешь, что workout появился в WHOOP.

Формат:
- гиря: `URL 12kg` или `URL 20kg`
- барре: `URL`
- опц теги (если хочешь явно): `URL bands` / `URL bodyweight`

Бот:
1) создаёт `pending_log` с timestamp `t_msg`
2) матчится к WHOOP workout (раздел 8)
3) при неоднозначности — выбор кандидата
4) спрашивает RPE 1–5

### 5.3 Логирование бега
- `/run` или кнопка из плана
- после пробежки: RPE 1–5
- если нужно уточнение: `Z3 (обычный)` / `Z4 (качество)` / `другое`

### 5.4 Утренний soreness/pain (умно)
Бот спрашивает утром **не всегда**, а когда это влияет на рекомендации:
- вчера был planned workout (ролик/бег)
- или был unattributed workout с высоким NeedMoreInfoScore
- или был “рискованный” день (лыжи/хайк/очень высокий strain)

Вопросы:
1) soreness 0–3
2) “где болит?” — если soreness>0 или вчера был рискованный тип

### 5.5 Авто-уточнение после unattributed активностей (“идеально”)
- Walk/Swim обычно не требуют вопросов
- Ski/Hike почти всегда требуют

Если нужно:
- RPE 1–5
- иногда “где болит” (если риск высокий)

### 5.6 Weekly prompt (вторник): VO2max_manual
Во вторник бот спрашивает:
- “Введи VO2max за неделю”
Команда: `/vo2 <число>`

---

## 6) Команды и кнопки (MVP)
### Команды
- `/start`
- `/plan`
- `/retry`
- `/last`
- `/undo`
- `/run`
- `/vo2 <num>`
- `/gear` `/gear_home` `/gear_bands` `/gear_none`
- `/help`

### Кнопки
- выбор A/B/C
- RPE 1–5
- soreness 0–3
- pain locations + `готово`
- отказ от ролика + причина:
  - “не мой стиль”, “слишком долго”, “скучно”, “слишком сложно”, “impact/прыжки”, “другое”

---

## 7) Каталог опций (что бот может предложить)
### Общие (всегда)
- Бег **Z3 base** (20/30/40/45)
- Бег **Z4 quality** (10–25 суммарно; формат A/B)
- Бег **Z2 run-walk** (опционально)
- Барре (ролик)
- Мобилити/восстановление (ролик)
- Ходьба/лёгкая активность

### Если `home_full`
- Гиря (ролик) + вес 12 или 20

### Если `travel_bands`
- Bands strength (ролики) — low-impact, фокус на posterior chain/core/upper

### Если `travel_none`
- Bodyweight strength (ролики) — low-impact strength / core / pilates

---

## 8) Матчинг “сообщение → WHOOP workout”
### 8.1 Поиск кандидатов
Для `pending_log` с timestamp `t_msg`:
- окно: **[t_msg - 3h, t_msg + 30m]**
- кандидат: workout, у которого `workout.end` попадает в окно

### 8.2 Выбор лучшего
Скоринг:
- основной: минимизировать `abs(workout.end - t_msg)`
- tie-breakers:
  - близость длительности к ролику (если известна)
  - тип ближе ожидаемому (run vs strength vs yoga и т.д.)
  - пересечение по времени

### 8.3 Неоднозначность
Если кандидатов несколько — показать список (start–end, type, duration, strain) и дать выбрать 1 тапом.

### 8.4 Не найдено
Попросить проверить WHOOP и нажать `/retry`.  
`/retry` расширяет окно вперёд на +60 минут (один раз).

---

## 9) NeedMoreInfoScore (когда спрашивать RPE по unattributed)
Score для unattributed workout:
- +2 если type ∈ {ski, hiking} (и близкие)
- +1 если duration > 90 мин
- +1 если strain выше персонального медианного для этого типа (после истории; до того — дефолтный порог)
- +1 если тип новый (меньше N=3)
- +1 если workout закончился поздно (например после 19:00)
- +1 если вчера уже был тяжёлый planned workout

Правило:
- score ≥ 2 → спросить RPE 1–5
- score ≥ 3 → спросить RPE + “где болит”

---

## 10) Hard constraints (жёсткие правила безопасности)
### 10.1 Инвентарь
- `travel_bands` и `travel_none`: гиря **никогда не показывается**
- `travel_none`: bands **никогда не показываются**

### 10.2 Боль (колено/икры/бедро)
- по умолчанию **скрываем весь бег** (Z2/Z3/Z4) и предлагаем low-impact + мобилити/барре/верх
- (MVP: без режима “всё равно хочу бег”; можно добавить позже)

### 10.3 Soreness
- soreness=3 → убрать бег; убрать тяжёлую силовую (гиря 20); оставить мобилити/барре лёгкое/ходьбу
- soreness=2 → запретить Z4; Z3 только если нет боли ног и recovery не низкий; иначе low-impact
- soreness=1 → Z3 допустим; Z4 только если recovery высокий и нет иных флагов нагрузки ног

### 10.4 Z4
- Z4 ≤ 2/7 дней
- ≥48 часов между Z4
- если вчера была тяжёлая нагрузка ног (гиря 20 с высоким RPE, лыжи/хайк, очень высокий strain) → Z4 сегодня не предлагать

---

## 11) Soft scoring (оптимизация benefit/cost)
Каждой опции считаем:
- **Benefit**
  - минуты Z1–Z3 (для тебя основной вклад — Z3)
  - бонус за Z4 минуты (если разрешено)
  - бонус за регулярность силовой/стабилизации (KB/Bands/Bodyweight) как поддержка бега
- **Cost**
  - прогноз “удар по recovery/сну завтра” (учится на твоей истории)
  - прогноз soreness (учится на твоей истории; для гири учитывает 12/20)
  - penalty за “нагрузка на ноги” (последние 48ч)

Выбор опций:
- A: максимум benefit при допустимом cost
- B: лучший баланс
- C (если нужно): минимальный cost (recovery-first)

---

## 12) VO₂max_est_submax (авто-оценка из бега + поправка на altitude)
### 12.1 Что считаем
Мы строим **тренд VO2max_est** из “steady” беговых тренировок на улице (у тебя это всегда outdoor).

Идея: оценить “кислородную стоимость” бега по скорости (и уклону), затем масштабировать к VO₂max через HR-reserve.

### 12.2 Входные данные (по каждому беговому workout)
Нужно:
- `distance_m`
- `duration_min` (end-start)
- `avg_hr`
- `altitude_gain_m` (суммарный набор высоты)
- `RHR` (resting HR) — берём из утреннего cycle / recovery
- `HRmax` — из WHOOP user/profile; если недоступно или сомнительно, задаём вручную в конфиге и используем его.

### 12.3 Фильтр “steady runs” (чтобы не засорять оценку)
Включаем workout в расчёт VO2max_est только если:
- тип = бег
- длительность ≥ 20 мин
- и (желательно) **нет Z4-структуры**: например, время в Z4 не доминирует (эвристика по zone_durations)
- и нет сильной боли ног/колена в этот/следующий день (если есть pain — исключаем)
- и RPE не “очень тяжело” (например RPE=5) (эвристика: такие пробежки чаще не субмакс)

Примечание: Z4-качество мы можем хранить отдельно как “performance”, но не мешать в VO2max_est_submax.

### 12.4 Расчёт
1) **Скорость**
- `v = distance_m / duration_min`  (м/мин)

2) **Оценка среднего уклона из набора высоты**
- `grade_up = altitude_gain_m / distance_m`  (доля)
- применяем “безопасный cap”, чтобы холмы не раздували оценку:
  - `grade_used = min(grade_up, 0.06)`  # 6% cap в MVP
- если `grade_up > 0.03` (3%), помечаем как `hill_run=true` и понижаем вес в агрегировании (см. 12.5)

3) **Оценка VO₂ на скорости (ACSM running, упрощённо)**
- `VO2_run = 3.5 + 0.2*v + 0.9*v*grade_used`  (мл/кг/мин)

4) **HRR (heart rate reserve fraction)**
- `HRR = (avg_hr - RHR) / (HRmax - RHR)`
- guardrails:
  - если HRR <= 0.2 → пропускаем (данные странные или слишком легко)
  - если HRR >= 0.95 → пропускаем (почти максимум, не submax)

5) **VO₂max_est**
- `VO2max_est = 3.5 + (VO2_run - 3.5) / HRR`

### 12.5 Weekly агрегирование
Раз в неделю считаем:
- `VO2max_est_week = weighted_median(VO2max_est over last 14 days steady runs)`
где веса:
- `w = 1.0` для обычных пробежек
- `w = 0.5` для `hill_run=true` (чтобы холмы влияли, но меньше)

Если за 14 дней нет ни одной подходящей steady run — weekly value = null.

### 12.6 Как показываем пользователю
Раз в неделю (в тот же вторник, рядом с ручным вводом) бот может прислать:
- `VO2max_manual: X`
- `VO2max_est_week: Y (trend vs 4wk)`
(Опционально, если хочешь: это можно включить как фичу отчёта.)

---

## 13) YouTube-рекомендации (пул + похожие + оценки)
### 13.1 Пул каналов
- старт: каналы из твоих ссылок
- расширение: любая новая ссылка от тебя добавляет канал в пул

### 13.2 Ранжирование
- твои оценки роликов + причины отказа
- ожидаемая “стоимость” (RPE/soreness после похожих роликов)
- роль в плане (лёгкий/силовой/мобилити/low-impact кардио)

### 13.3 Отказ с причиной
Причины влияют на будущее:
- “не мой стиль” → понижаем похожие каналы
- “слишком сложно” → понижаем похожие по структуре
- “impact/прыжки” → маркируем как нежелательное

---

## 14) Канонические форматы сообщений
### 14.1 Утренний план
- Recovery + сон
- “Инвентарь сегодня: …”
- “Сегодня (выбери 1)” — 2–3 опции
- “Завтра/послезавтра” — ветвления
- кнопки A/B/C + `/plan`

### 14.2 Лог тренировки
- подтверждение матча (или выбор кандидата)
- RPE 1–5
- если гиря и нет веса → уточнить 12/20

### 14.3 Уточнение по ski/hike/необычному
- “вижу Skiing … — оцени нагрузку”
- RPE 1–5
- при необходимости “где болит”

### 14.4 Утренний soreness/pain
- soreness 0–3
- pain locations

### 14.5 Инвентарь
- `/gear` → “Сейчас: …” + кнопки `[дом] [ремни] [ничего]`

---

## 15) Хранение данных (минимум)
- `users`: telegram_id, whoop_user_id, tokens, preferences (incl. equipment_profile, optional HRmax_override)
- `videos`: video_id, channel_id, title, duration(optional), language, tags(optional)
- `workouts`: whoop_workout_id, start, end, type, strain, avg_hr, distance_m, altitude_gain_m, zone_durations, attributed(bool)
- `logs`: log_id, user_id, created_at, source(video/run), video_id?, kb_weight?, whoop_workout_id?, equipment_profile_at_time
- `feedback`: whoop_workout_id, rpe_1_5, soreness_0_3(date), pain_locations[], reject_reason?
- `weekly_metrics`: week_id, vo2max_manual, vo2max_est_week, notes(optional)

Экспорт (optional MVP):
- `/export` → CSV/JSON (logs/workouts/feedback/weekly_metrics)

---

## 16) Edge cases
- workout не появился в WHOOP → `/retry`
- несколько workout рядом → выбор кандидата
- травма/колено → боль отмечена → бег скрываем по умолчанию
- в поездке → меняешь `equipment_profile`, гиря исчезает из опций
- холмистые пробежки → `hill_run=true`, меньший вес в VO2max_est_week

---

## 17) Non-goals (не делаем в MVP)
- WHOOP Age (полностью исключаем)
- глобальный поиск по всему YouTube без контроля качества
- медицинская диагностика
- внешние девайсы (не нужны)

---

## 18) Acceptance criteria
1) Бот шлёт план на 3 дня после утреннего Recovery (по вебхуку).
2) Лог ролика после тренировки матчится к WHOOP workout (с выбором кандидата и `/retry`).
3) Бот собирает RPE 1–5; утром soreness 0–3 и “где болит” по правилам.
4) Unattributed активности учитываются; бот спрашивает RPE только когда NeedMoreInfoScore высокий (лыжи/хайк/необычно).
5) Бот спрашивает VO2max_manual по вторникам и хранит историю.
6) Бот считает weekly `VO2max_est_submax` из бегов (distance + avg HR + altitude gain) и хранит историю.
7) В планах бег по умолчанию предлагается как **Z3 base**, Z2 — опционально, Z4 — качество с лимитами.
8) `equipment_profile` переключается (home/bands/none) и корректно меняет каталог опций (гиря скрывается в travel режимах).
9) YouTube-рекомендации работают на пуле каналов и учитывают отказы с причиной.
